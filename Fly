# app.py
import os
import smtplib
import schedule
import time
from datetime import datetime
from email.mime.text import MimeText
from email.mime.multipart import MimeMultipart
import pandas as pd
import numpy as np
import yfinance as yf
import ta
from flask import Flask

app = Flask(__name__)

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø¹Ø¯Ù„ Ù‡Ø°Ù‡)
EMAIL_CONFIG = {
    'smtp_server': 'smtp.gmail.com',
    'smtp_port': 587,
    'sender_email': 'your_email@gmail.com',
    'sender_password': 'your_app_password',  # Ø§Ø³ØªØ®Ø¯Ø§Ù… App Password Ù„ÙŠØ³ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    'receiver_email': 'receiver@gmail.com'
}

class AdvancedTradingSignals:
    def __init__(self):
        self.signals_history = []
    
    def calculate_indicators(self, df):
        """Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©"""
        # Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
        df['SMA_9'] = ta.trend.sma_indicator(df['close'], window=9)
        df['SMA_21'] = ta.trend.sma_indicator(df['close'], window=21)
        df['EMA_12'] = ta.trend.ema_indicator(df['close'], window=12)
        df['EMA_26'] = ta.trend.ema_indicator(df['close'], window=26)
        
        # RSI Ø¨Ù…Ø³ØªÙˆÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
        df['RSI'] = ta.momentum.rsi(df['close'], window=14)
        df['RSI_7'] = ta.momentum.rsi(df['close'], window=7)
        
        # MACD
        macd = ta.trend.MACD(df['close'])
        df['MACD'] = macd.macd()
        df['MACD_Signal'] = macd.macd_signal()
        df['MACD_Histogram'] = macd.macd_diff()
        
        # Bollinger Bands
        bollinger = ta.volatility.BollingerBands(df['close'])
        df['BB_Upper'] = bollinger.bollinger_hband()
        df['BB_Lower'] = bollinger.bollinger_lband()
        df['BB_Middle'] = bollinger.bollinger_mavg()
        
        # ATR
        df['ATR'] = ta.volatility.average_true_range(df['high'], df['low'], df['close'])
        
        # Volume indicators
        df['Volume_SMA'] = df['volume'].rolling(20).mean()
        
        # Stochastic
        stoch = ta.momentum.StochasticOscillator(df['high'], df['low'], df['close'])
        df['Stoch_K'] = stoch.stoch()
        df['Stoch_D'] = stoch.stoch_signal()
        
        return df
    
    def analyze_signals(self, symbol="EURUSD=X", timeframe="60m"):
        """ØªØ­Ù„ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù„Ù„Ø¥Ø´Ø§Ø±Ø§Øª"""
        try:
            # Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            data = yf.download(symbol, period="1mo", interval=timeframe, progress=False)
            if data.empty:
                return None
            
            df = self.calculate_indicators(data)
            current = df.iloc[-1]
            previous = df.iloc[-2]
            
            signal_strength = 0
            signals = []
            confidence_reasons = []
            
            # 1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (ÙˆØ²Ù† 30%)
            ma_signals = []
            if current['SMA_9'] > current['SMA_21'] and previous['SMA_9'] <= previous['SMA_21']:
                ma_signals.append("SMA 9 Ø¹Ø¨Ø± ÙÙˆÙ‚ SMA 21")
                signal_strength += 15
            elif current['SMA_9'] < current['SMA_21'] and previous['SMA_9'] >= previous['SMA_21']:
                ma_signals.append("SMA 9 Ø¹Ø¨Ø± ØªØ­Øª SMA 21")
                signal_strength -= 15
            
            if current['EMA_12'] > current['EMA_26']:
                ma_signals.append("EMA 12 ÙÙˆÙ‚ EMA 26")
                signal_strength += 10
            else:
                ma_signals.append("EMA 12 ØªØ­Øª EMA 26")
                signal_strength -= 10
            
            if ma_signals:
                confidence_reasons.extend(ma_signals)
            
            # 2. ØªØ­Ù„ÙŠÙ„ RSI (ÙˆØ²Ù† 25%)
            rsi_signals = []
            if current['RSI'] < 30:
                rsi_signals.append("RSI ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø°Ø±ÙˆØ© Ø§Ù„Ø¨ÙŠØ¹ (<30)")
                signal_strength += 20
            elif current['RSI'] > 70:
                rsi_signals.append("RSI ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø°Ø±ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¡ (>70)")
                signal_strength -= 20
            elif 40 < current['RSI'] < 60:
                rsi_signals.append("RSI ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ù…Ø­Ø§ÙŠØ¯Ø©")
            
            if rsi_signals:
                confidence_reasons.extend(rsi_signals)
            
            # 3. ØªØ­Ù„ÙŠÙ„ MACD (ÙˆØ²Ù† 20%)
            if current['MACD'] > current['MACD_Signal'] and previous['MACD'] <= previous['MACD_Signal']:
                confidence_reasons.append("MACD Ø¥ÙŠØ¬Ø§Ø¨ÙŠ")
                signal_strength += 10
            elif current['MACD'] < current['MACD_Signal'] and previous['MACD'] >= previous['MACD_Signal']:
                confidence_reasons.append("MACD Ø³Ù„Ø¨ÙŠ")
                signal_strength -= 10
            
            # 4. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø¨Ø§Ù†Ø¯ (ÙˆØ²Ù† 15%)
            if current['close'] < current['BB_Lower']:
                confidence_reasons.append("Ø§Ù„Ø³Ø¹Ø± ØªØ­Øª Ø§Ù„Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø³ÙÙ„ÙŠ (Ø°Ø±ÙˆØ© Ø¨ÙŠØ¹)")
                signal_strength += 8
            elif current['close'] > current['BB_Upper']:
                confidence_reasons.append("Ø§Ù„Ø³Ø¹Ø± ÙÙˆÙ‚ Ø§Ù„Ø¨ÙˆÙ„ÙŠÙ†Ø¬Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø°Ø±ÙˆØ© Ø´Ø±Ø§Ø¡)")
                signal_strength -= 8
            
            # 5. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙˆÙƒØ§Ø³ØªÙƒ (ÙˆØ²Ù† 10%)
            if current['Stoch_K'] < 20 and current['Stoch_D'] < 20:
                confidence_reasons.append("Ø§Ù„Ø§Ø³ØªÙˆÙƒØ§Ø³ØªÙƒ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø°Ø±ÙˆØ© Ø§Ù„Ø¨ÙŠØ¹")
                signal_strength += 5
            elif current['Stoch_K'] > 80 and current['Stoch_D'] > 80:
                confidence_reasons.append("Ø§Ù„Ø§Ø³ØªÙˆÙƒØ§Ø³ØªÙƒ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø°Ø±ÙˆØ© Ø§Ù„Ø´Ø±Ø§Ø¡")
                signal_strength -= 5
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            if signal_strength >= 20:
                final_signal = "Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ ğŸŸ¢"
            elif signal_strength >= 10:
                final_signal = "Ø´Ø±Ø§Ø¡ ğŸŸ¢"
            elif signal_strength <= -20:
                final_signal = "Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ ğŸ”´"
            elif signal_strength <= -10:
                final_signal = "Ø¨ÙŠØ¹ ğŸ”´"
            else:
                final_signal = "Ù…Ø­Ø§ÙŠØ¯ âšª"
            
            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‡Ø¯Ù ÙˆÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©
            atr_value = current['ATR'] if not pd.isna(current['ATR']) else data['close'].std() * 0.01
            
            result = {
                'symbol': symbol,
                'timestamp': datetime.now(),
                'signal': final_signal,
                'signal_strength': signal_strength,
                'current_price': round(current['close'], 4),
                'rsi': round(current['RSI'], 2),
                'macd': round(current['MACD'], 4),
                'sma_9': round(current['SMA_9'], 4),
                'sma_21': round(current['SMA_21'], 4),
                'atr': round(atr_value, 4),
                'confidence_reasons': confidence_reasons,
                'take_profit': round(current['close'] + (2 * atr_value), 4) if signal_strength > 0 else round(current['close'] - (2 * atr_value), 4),
                'stop_loss': round(current['close'] - (1.5 * atr_value), 4) if signal_strength > 0 else round(current['close'] + (1.5 * atr_value), 4),
                'timeframe': timeframe
            }
            
            self.signals_history.append(result)
            return result
            
        except Exception as e:
            print(f"Error in analysis: {e}")
            return None

def send_email_alert(signal_data):
    """Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"""
    try:
        msg = MimeMultipart()
        msg['From'] = EMAIL_CONFIG['sender_email']
        msg['To'] = EMAIL_CONFIG['receiver_email']
        msg['Subject'] = f"ğŸ“ˆ ØªÙ†Ø¨ÙŠÙ‡ ØªØ¯Ø§ÙˆÙ„: {signal_data['signal']} - {signal_data['symbol']}"
        
        # Ø¨Ù†Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        body = f"""
        ğŸš€ Ø¥Ø´Ø§Ø±Ø© ØªØ¯Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯Ø© ğŸš€
        
        Ø§Ù„Ø²ÙˆØ¬: {signal_data['symbol']}
        Ø§Ù„ÙˆÙ‚Øª: {signal_data['timestamp'].strftime('%Y-%m-%d %H:%M:%S')}
        Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: {signal_data['timeframe']}
        
        ğŸ“Š Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal_data['signal']}
        Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: {signal_data['signal_strength']}
        
        ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ: {signal_data['current_price']}
        ğŸ¯ Ù‡Ø¯Ù Ø§Ù„Ø±Ø¨Ø­: {signal_data['take_profit']}
        ğŸ›‘ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: {signal_data['stop_loss']}
        
        ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª:
        - RSI: {signal_data['rsi']}
        - MACD: {signal_data['macd']}
        - SMA 9: {signal_data['sma_9']}
        - SMA 21: {signal_data['sma_21']}
        - ATR: {signal_data['atr']}
        
        ğŸ“‹ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø«Ù‚Ø©:
        {chr(10).join(['â€¢ ' + reason for reason in signal_data['confidence_reasons']])}
        
        âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ù‡ Ù„ÙŠØ³Øª Ù†ØµÙŠØ­Ø© Ù…Ø§Ù„ÙŠØ©ØŒ Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø«Ùƒ Ø§Ù„Ø®Ø§Øµ.
        """
        
        msg.attach(MimeText(body, 'plain'))
        
        server = smtplib.SMTP(EMAIL_CONFIG['smtp_server'], EMAIL_CONFIG['smtp_port'])
        server.starttls()
        server.login(EMAIL_CONFIG['sender_email'], EMAIL_CONFIG['sender_password'])
        server.send_message(msg)
        server.quit()
        
        print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­")
        return True
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: {e}")
        return False

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
trading_bot = AdvancedTradingSignals()

def check_signals_and_alert():
    """ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª"""
    symbols = ["EURUSD=X", "GBPUSD=X", "USDJPY=X", "BTC-USD", "ETH-USD"]
    
    for symbol in symbols:
        print(f"ğŸ” ØªØ­Ù„ÙŠÙ„ {symbol}...")
        signal = trading_bot.analyze_signals(symbol, "60m")
        
        if signal and abs(signal['signal_strength']) >= 15:  # Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù‚ÙˆÙŠØ©
            print(f"ğŸ¯ Ø¥Ø´Ø§Ø±Ø© Ù‚ÙˆÙŠØ© Ù„Ù€ {symbol}: {signal['signal']}")
            send_email_alert(signal)
        elif signal:
            print(f"âšª Ø¥Ø´Ø§Ø±Ø© Ø¹Ø§Ø¯ÙŠØ© Ù„Ù€ {symbol}: {signal['signal']}")
        time.sleep(2)  # ØªØ¬Ù†Ø¨ rate limits

@app.route('/')
def home():
    return "ğŸ¤– Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙŠØ¹Ù…Ù„! ØªØªØ¨Ø¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª."

@app.route('/check-now')
def check_now():
    """ÙØ­Øµ ÙŠØ¯ÙˆÙŠ"""
    check_signals_and_alert()
    return "ØªÙ… Ø§Ù„ÙØ­Øµ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø¥Ø´Ø§Ø±Ø§Øª Ù‚ÙˆÙŠØ©"

if __name__ == '__main__':
    # Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ÙØ­Øµ ÙƒÙ„ Ø³Ø§Ø¹Ø©
    schedule.every(1).hours.do(check_signals_and_alert)
    
    # ÙØ­Øµ Ø£ÙˆÙ„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    check_signals_and_alert()
    
    print("ğŸš€ Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙŠØ¹Ù…Ù„...")
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙˆØ§Ù„Ø®Ø§Ø¯Ù…
    from threading import Thread
    Thread(target=app.run, kwargs={'host': '0.0.0.0', 'port': int(os.environ.get('PORT', 5000))}).start()
    
    # Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    while True:
        schedule.run_pending()
        time.sleep(1)
